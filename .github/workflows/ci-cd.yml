name: CI/CD Pipeline - RTE Consommation
# RNCP C18: Intégrer en continu les évolutions de l'application
# RNCP C19: Déployer en continu l'application

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  tests:
    name: Tests automatisés
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest with coverage
        run: |
          pytest tests/ -v --cov=api --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: matrix.python-version == '3.12'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  code-quality:
    name: Qualité du code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install linting tools
        run: |
          pip install flake8 black isort

      - name: Check code formatting with Black
        run: |
          black --check --diff api/ src/ tests/

      - name: Check imports with isort
        run: |
          isort --check-only api/ src/ tests/

      - name: Lint with flake8
        run: |
          flake8 api/ src/ tests/ --max-line-length=100 --extend-ignore=E203,W503

  model-validation:
    name: Validation des modèles ML
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run model-specific tests
        run: |
          pytest tests/test_model.py -v --tb=short

      - name: Check model file exists
        run: |
          if [ -f "ml/models/rte_conso_model.pkl" ]; then
            echo "Model file found"
            ls -lh ml/models/rte_conso_model.pkl
          else
            echo "Model file not found (OK for new branches)"
          fi

  security-scan:
    name: Scan de sécurité - RNCP C17
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r api/ src/ -f json -o bandit-report.json || true

      - name: Check for vulnerabilities in dependencies
        run: |
          pip install safety
          pip install -r requirements.txt
          safety check --json || true

  build-status:
    name: Build Status Summary
    runs-on: ubuntu-latest
    needs: [tests, code-quality, model-validation, security-scan]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "CI/CD Pipeline completed"
          echo "Tests: ${{ needs.tests.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Model Validation: ${{ needs.model-validation.result }}"
          echo "Security: ${{ needs.security-scan.result }}"
